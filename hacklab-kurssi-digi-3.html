<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html lang="en" xml:lang="en" xmlns="http://www.w3.org/1999/xhtml">
 <head>
  <meta content="text/html; charset=utf-8" http-equiv="Content-type"/>
  <meta content="en-us" http-equiv="Content-Language"/>
  <title>
   /hacklab-kurssi-digi-3
  </title>
 </head>
 <body>
  Tämä sivu:
  <a href="./hacklab-kurssi-digi-3.html">
   https://kirjoitusalusta.fi/hacklab-kurssi-digi-3
  </a>
  <br/>
  <br/>
  Torstai 2.6.2016:
  <br/>
  <a href="https://www.dropbox.com/sh/r1jfi4a7n546bku/AADc7RaN73wM_sxmmAF8LtgDa?dl=0">
   https://www.dropbox.com/sh/r1jfi4a7n546bku/AADc7RaN73wM_sxmmAF8LtgDa?dl=0
  </a>
  <br/>
  <br/>
  <br/>
  #**************************************************************************************************************************************************#
  <br/>
  #                                        UCF for Blue Chinese Spartan6                                                                                    #
  <br/>
  #**************************************************************************************************************************************************#
  <br/>
  <br/>
  CONFIG VCCAUX = "3.3" ;
  <br/>
  <br/>
  NET "CLK50"                       LOC = P21     | IOSTANDARD = LVCMOS33 | PERIOD = 50MHz ;
  <br/>
  <br/>
  ###################################################################################################################################################
  <br/>
  #                                                    VGA                                                                                          #
  <br/>
  ###################################################################################################################################################
  <br/>
  NET "vga_hsync"                   LOC = P16     | IOSTANDARD = LVCMOS33 | DRIVE = 8 | SLEW = FAST ;
  <br/>
  NET "vga_vsync"                   LOC = P17     | IOSTANDARD = LVCMOS33 | DRIVE = 8 | SLEW = FAST ;
  <br/>
  <br/>
  NET "vga_R[3]"                    LOC = P11     | IOSTANDARD = LVCMOS33 | DRIVE = 8 | SLEW = FAST ;
  <br/>
  NET "vga_R[2]"                    LOC = P12     | IOSTANDARD = LVCMOS33 | DRIVE = 8 | SLEW = FAST ;
  <br/>
  NET "vga_R[1]"                    LOC = P14     | IOSTANDARD = LVCMOS33 | DRIVE = 8 | SLEW = FAST ;
  <br/>
  NET "vga_R[0]"                    LOC = P15     | IOSTANDARD = LVCMOS33 | DRIVE = 8 | SLEW = FAST ;
  <br/>
  <br/>
  NET "vga_G[3]"                    LOC = P7      | IOSTANDARD = LVCMOS33 | DRIVE = 8 | SLEW = FAST ;
  <br/>
  NET "vga_G[2]"                    LOC = P8      | IOSTANDARD = LVCMOS33 | DRIVE = 8 | SLEW = FAST ;
  <br/>
  NET "vga_G[1]"                    LOC = P9      | IOSTANDARD = LVCMOS33 | DRIVE = 8 | SLEW = FAST ;
  <br/>
  NET "vga_G[0]"                    LOC = P10     | IOSTANDARD = LVCMOS33 | DRIVE = 8 | SLEW = FAST ;
  <br/>
  <br/>
  NET "vga_B[3]"                    LOC = P1      | IOSTANDARD = LVCMOS33 | DRIVE = 8 | SLEW = FAST ;
  <br/>
  NET "vga_B[2]"                    LOC = P2      | IOSTANDARD = LVCMOS33 | DRIVE = 8 | SLEW = FAST ;
  <br/>
  NET "vga_B[1]"                    LOC = P5      | IOSTANDARD = LVCMOS33 | DRIVE = 8 | SLEW = FAST ;
  <br/>
  NET "vga_B[0]"                    LOC = P6      | IOSTANDARD = LVCMOS33 | DRIVE = 8 | SLEW = FAST ;
  <br/>
  <br/>
  <br/>
  #**************************************************************************************************************************************************#
  <br/>
  #                                            UCF for X-SP6-X9                                                                                      #
  <br/>
  #                                                                                                                                                  #
  <br/>
  #                      From silk screen markings and reverse engineering by JK 27.3.2016                                                           #
  <br/>
  #                                                                                                                                                  #
  <br/>
  #**************************************************************************************************************************************************#
  <br/>
  <br/>
  CONFIG VCCAUX = "3.3" ;
  <br/>
  <br/>
  NET "CLK_50M"                      LOC = P126     | IOSTANDARD = LVCMOS33 | PERIOD = 50MHz ;
  <br/>
  <br/>
  ###################################################################################################################################################
  <br/>
  #                                                    VGA                                                                                          #
  <br/>
  ###################################################################################################################################################
  <br/>
  NET "VGA_HSYNC"                  LOC = P95     | IOSTANDARD = LVCMOS33 | DRIVE = 8 | SLEW = FAST ;
  <br/>
  NET "VGA_VSYNC"                  LOC = P97     | IOSTANDARD = LVCMOS33 | DRIVE = 8 | SLEW = FAST ;
  <br/>
  <br/>
  NET "VGA_R"                      LOC = P100    | IOSTANDARD = LVCMOS33 | DRIVE = 8 | SLEW = FAST ;
  <br/>
  NET "VGA_G"                      LOC = P99     | IOSTANDARD = LVCMOS33 | DRIVE = 8 | SLEW = FAST ;
  <br/>
  NET "VGA_B"                      LOC = P98     | IOSTANDARD = LVCMOS33 | DRIVE = 8 | SLEW = FAST ;
  <br/>
  <br/>
  ###################################################################################################################################################
  <br/>
  #                                                    Buzzer                                                                                       #
  <br/>
  ###################################################################################################################################################
  <br/>
  NET "BUZZER"                      LOC = P94     | IOSTANDARD = LVCMOS33 | DRIVE = 8 | SLEW = FAST ;  #silk wrong
  <br/>
  <br/>
  <br/>
  <br/>
  <br/>
  <br/>
  <br/>
  <b>
   ------------------------------------------------------------------- main.v -------------------------------------------------------------------------
  </b>
  <br/>
  <br/>
  // main.v
  <br/>
  <br/>
  `timescale 1ns / 1ps
  <br/>
  `default_nettype none
  <br/>
  <br/>
  <br/>
  module Main #(
  <br/>
  parameter                    EXTERNAL_CLOCK_FREQUENCY_HZ = 100_000_000,
  <br/>
  parameter                    EXTERNAL_CLOCK_PERIOD_NS = 1000000000.0/EXTERNAL_CLOCK_FREQUENCY_HZ
  <br/>
  ) (
  <br/>
  input wire                     EXTERNAL_CLOCK,
  <br/>
  <br/>
  input wire                     BUTTON_UP,
  <br/>
  input wire                     BUTTON_DOWN,
  <br/>
  <br/>
  // R3G3B2
  <br/>
  output reg [2:0]             VGA_RED,
  <br/>
  output reg [2:0]            VGA_GREEN,
  <br/>
  output reg [1:0]            VGA_BLUE,
  <br/>
  output reg                      VGA_HSYNC,
  <br/>
  output reg                    VGA_VSYNC,
  <br/>
  <br/>
  // R1G1B1
  <br/>
  //output reg                     VGA_RED,
  <br/>
  //output reg                       VGA_GREEN,
  <br/>
  //output reg                     VGA_BLUE,
  <br/>
  //output reg                      VGA_HSYNC,
  <br/>
  //output reg                    VGA_VSYNC,
  <br/>
  <br/>
  output    wire [7:0]             LED
  <br/>
  );
  <br/>
  <br/>
  initial $display("Main # EXTERNAL_CLOCK_FREQUENCY_HZ = %.3f", EXTERNAL_CLOCK_FREQUENCY_HZ);
  <br/>
  initial $display("Main # EXTERNAL_CLOCK_PERIOD_NS = %.3f", EXTERNAL_CLOCK_PERIOD_NS);
  <br/>
  <br/>
  // 640x480 @ 60Hz =&gt; 25 MHz pixel clock
  <br/>
  parameter PIXEL_CLOCK_MULTIPLY =        1;
  <br/>
  parameter PIXEL_CLOCK_DIVIDE =            4;
  <br/>
  parameter PIXEL_CLOCK_HZ =                EXTERNAL_CLOCK_FREQUENCY_HZ*PIXEL_CLOCK_MULTIPLY/PIXEL_CLOCK_DIVIDE;
  <br/>
  <br/>
  initial $display("Main # PIXEL_CLOCK_MHZ = %.3f", PIXEL_CLOCK_HZ/1000000.0);
  <br/>
  <br/>
  parameter HORIZONTAL_PIXELS =            640;        // Horizontal live pixels
  <br/>
  parameter HORIZONTAL_FRONT_PORTCH =        16;            // Horizontal front portch
  <br/>
  parameter HORIZONTAL_SYNC =                96;            // HSYNC pulse width
  <br/>
  parameter HORIZONTAL_BACK_PORTCH =        48;            // Horizontal back portch
  <br/>
  parameter HORIZONTAL_TOTAL = HORIZONTAL_PIXELS + HORIZONTAL_FRONT_PORTCH + HORIZONTAL_SYNC + HORIZONTAL_BACK_PORTCH;        // Horizontal Total Pixels
  <br/>
  <br/>
  parameter VERTICAL_PIXELS =                480;        // Vertical live lines
  <br/>
  parameter VERTICAL_FRONT_PORTCH =        10;            // Vertical front portch
  <br/>
  parameter VERTICAL_SYNC =                2;            // VSYNC pulse width
  <br/>
  parameter VERTICAL_BACK_PORTCH =        33;            // Vertical back portch
  <br/>
  parameter VERTICAL_TOTAL = VERTICAL_PIXELS + VERTICAL_FRONT_PORTCH + VERTICAL_SYNC + VERTICAL_BACK_PORTCH;        // Horizontal Total Pixels
  <br/>
  <br/>
  parameter TOTAL_PIXELS = HORIZONTAL_TOTAL * VERTICAL_TOTAL;
  <br/>
  <br/>
  initial $display("Main # HORIZONTAL_TOTAL = %d", HORIZONTAL_TOTAL);
  <br/>
  initial $display("Main # VERTICAL_TOTAL = %d", VERTICAL_TOTAL);
  <br/>
  initial $display("Main # TOTAL_PIXELS = %d", TOTAL_PIXELS);
  <br/>
  <br/>
  <br/>
  wire     external_clock;
  <br/>
  IBUFG ibufg0(
  <br/>
  .I(EXTERNAL_CLOCK),
  <br/>
  .O(external_clock)
  <br/>
  );
  <br/>
  <br/>
  wire     pixel_clock;
  <br/>
  wire     pixel_clock_x10;
  <br/>
  ClockScalerX10 #(
  <br/>
  .INPUT_CLOCK_PERIOD_NS(EXTERNAL_CLOCK_PERIOD_NS),
  <br/>
  .MULTIPLY(10*PIXEL_CLOCK_MULTIPLY),
  <br/>
  .DIVIDE(PIXEL_CLOCK_DIVIDE)
  <br/>
  ) clock_scaler(
  <br/>
  .input_clock(external_clock),
  <br/>
  .output_clock(pixel_clock),
  <br/>
  .output_clock_x10(pixel_clock_x10)
  <br/>
  );
  <br/>
  <br/>
  reg                            active = 1'b0;
  <br/>
  reg                [23:0]        frame = 24'd0;
  <br/>
  reg    signed        [11:0]        x = 1'd0;
  <br/>
  reg    signed         [11:0]        y = 1'd0;
  <br/>
  <br/>
  wire            [7:0]        red;
  <br/>
  wire            [7:0]        green;
  <br/>
  wire            [7:0]        blue;
  <br/>
  <br/>
  always @ (posedge pixel_clock) begin
  <br/>
  // VGA signal generator
  <br/>
  if (x == HORIZONTAL_TOTAL - 1) begin
  <br/>
  x &lt;= 1'd0;
  <br/>
  if (y == VERTICAL_TOTAL - 1) begin
  <br/>
  y &lt;= 1'd0;
  <br/>
  frame &lt;= frame + 1'd1;
  <br/>
  end else begin
  <br/>
  y &lt;= y + 1'd1;
  <br/>
  end
  <br/>
  end else begin
  <br/>
  x &lt;= x + 1'd1;
  <br/>
  end
  <br/>
  <br/>
  // Active pixels
  <br/>
  active &lt;= (x &lt; HORIZONTAL_PIXELS &amp;&amp; y &lt; VERTICAL_PIXELS);
  <br/>
  <br/>
  // Horizontal sync
  <br/>
  if (x &gt;= (HORIZONTAL_PIXELS + HORIZONTAL_FRONT_PORTCH) &amp;&amp; x &lt; (HORIZONTAL_PIXELS + HORIZONTAL_FRONT_PORTCH + HORIZONTAL_SYNC)) begin
  <br/>
  VGA_HSYNC &lt;= 1'b0;
  <br/>
  end else begin
  <br/>
  VGA_HSYNC &lt;= 1'b1;
  <br/>
  end
  <br/>
  <br/>
  // Vertical sync
  <br/>
  if (y &gt;= (VERTICAL_PIXELS + VERTICAL_FRONT_PORTCH) &amp;&amp; y &lt; (VERTICAL_PIXELS + VERTICAL_FRONT_PORTCH + VERTICAL_SYNC)) begin
  <br/>
  VGA_VSYNC &lt;= 1'b0;
  <br/>
  end else begin
  <br/>
  VGA_VSYNC &lt;= 1'b1;
  <br/>
  end
  <br/>
  end
  <br/>
  <br/>
  assign LED = {VGA_HSYNC, VGA_HSYNC, VGA_HSYNC, VGA_HSYNC, VGA_VSYNC, VGA_VSYNC, VGA_VSYNC, VGA_VSYNC};
  <br/>
  <br/>
  <br/>
  PixelShader #(
  <br/>
  .WIDTH(HORIZONTAL_PIXELS),
  <br/>
  .HEIGHT(VERTICAL_PIXELS)
  <br/>
  ) pixel_shader(
  <br/>
  .pixel_clock(pixel_clock),
  <br/>
  .active(active),
  <br/>
  .frame(frame),
  <br/>
  .x(x),
  <br/>
  .y(y),
  <br/>
  <br/>
  .red(red),
  <br/>
  .green(green),
  <br/>
  .blue(blue)
  <br/>
  );
  <br/>
  <br/>
  reg signed        [11:0]        red_accu;
  <br/>
  reg signed        [11:0]        green_accu;
  <br/>
  reg signed        [11:0]        blue_accu;
  <br/>
  <br/>
  reg                [30:0]        lfsr31 = 1'd1;
  <br/>
  always @(posedge pixel_clock_x10) begin
  <br/>
  lfsr31 &lt;= {lfsr31[9] ^ lfsr31[5] ^ lfsr31[0], lfsr31[30:1]};
  <br/>
  <br/>
  if (~VGA_VSYNC &amp;&amp; ~BUTTON_DOWN) begin
  <br/>
  lfsr31 &lt;= 1'd1;
  <br/>
  end
  <br/>
  <br/>
  red_accu = red;
  <br/>
  green_accu = green;
  <br/>
  blue_accu = blue;
  <br/>
  <br/>
  if (~BUTTON_UP) begin
  <br/>
  <br/>
  // R1G1B1
  <br/>
  red_accu = red_accu + lfsr31[7:0] - 128;
  <br/>
  green_accu = green_accu + lfsr31[7:0] - 128;
  <br/>
  blue_accu = blue_accu + lfsr31[7:0] - 128;
  <br/>
  <br/>
  // R3G3B2
  <br/>
  red_accu = red_accu + lfsr31[5:0] - 32;
  <br/>
  green_accu = green_accu + lfsr31[5:0] - 32;
  <br/>
  blue_accu = blue_accu + lfsr31[6:0] - 64;
  <br/>
  <br/>
  end
  <br/>
  <br/>
  // Saturate to 0..255
  <br/>
  if (red_accu &lt; 0) red_accu = 0;
  <br/>
  if (red_accu &gt; 255) red_accu = 255;
  <br/>
  if (green_accu &lt; 0) green_accu = 0;
  <br/>
  if (green_accu &gt; 255) green_accu = 255;
  <br/>
  if (blue_accu &lt; 0) blue_accu = 0;
  <br/>
  if (blue_accu &gt; 255) blue_accu = 255;
  <br/>
  <br/>
  // R3G3B2
  <br/>
  VGA_RED &lt;= {3{red_accu[7]}};    // red_accu[7:5];
  <br/>
  VGA_GREEN &lt;= {3{green_accu[7]}};    // green_accu[7:5];
  <br/>
  VGA_BLUE &lt;= {2{blue_accu[7]}};        // blue_accu[7:6];
  <br/>
  <br/>
  // R1G1B1
  <br/>
  //VGA_RED &lt;= red_accu[7];
  <br/>
  //VGA_GREEN &lt;= green_accu[7];
  <br/>
  //VGA_BLUE &lt;= blue_accu[7];
  <br/>
  <br/>
  end
  <br/>
  <br/>
  endmodule
  <br/>
  <br/>
  <br/>
  ------- Pixel shader ------
  <br/>
  <br/>
  <br/>
  always @ (posedge pixel_clock) begin
  <br/>
  red &lt;= 8'd0;
  <br/>
  green &lt;= 8'd0;
  <br/>
  blue &lt;= 8'd0;
  <br/>
  <br/>
  if (active) begin
  <br/>
  red &lt;= (255*x*dx &gt;&gt; 16);
  <br/>
  green &lt;= (255*y*dy &gt;&gt; 16);
  <br/>
  blue &lt;= 255 - ((red+green) &gt;&gt; 1);
  <br/>
  end
  <br/>
  end
  <br/>
  <br/>
  <br/>
  <br/>
  <br/>
 </body>
</html>