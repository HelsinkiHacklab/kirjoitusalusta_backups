<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<meta http-equiv="Content-type" content="text/html; charset=utf-8" />
<meta http-equiv="Content-Language" content="en-us" />
<title>/hacklab-soft-pwm</title>
</head>
<body><br
/><br
/>#define GREYSCALES 128<br
/>#define LATCH_PORT B00000001<br
/>#define CLOCK_PORT B00010000<br
/>#define DATA_PORT B00001000<br
/><br
/><br
/>//Pin connected to ST_CP of 74HC595<br
/>int latchPin = 8;<br
/>//Pin connected to SH_CP of 74HC595<br
/>int clockPin = 12;<br
/>////Pin connected to DS of 74HC595<br
/>int dataPin = 11;<br
/><br
/>//holder for infromation you're going to pass to shifting function<br
/>byte data = 0;&nbsp;<br
/><br
/><br
/>inline void latchOn() {<br
/>&nbsp; // Port 8<br
/>&nbsp; PORTB |=&nbsp; B00000001;<br
/>}<br
/><br
/>inline void latchOff() {<br
/>&nbsp; // Port 8<br
/>&nbsp; PORTB &amp;= ~B00000001;<br
/>}<br
/><br
/>inline void dataOn() {<br
/>&nbsp; // Port 11<br
/>&nbsp; PORTB |=&nbsp; B00001000;<br
/>}<br
/><br
/>inline void dataOff() {<br
/>&nbsp; // Port 11<br
/>&nbsp; PORTB &amp;= ~B00001000;<br
/>}<br
/><br
/>inline void clockOn() {<br
/>&nbsp; // Port 12<br
/>&nbsp; PORTB |=&nbsp; B00010000;<br
/>}<br
/><br
/>inline void clockOff() {<br
/>&nbsp; // Port 12<br
/>&nbsp; PORTB &amp;= ~B00010000;<br
/>}<br
/><br
/><br
/><br
/><br
/>void setup() {<br
/>&nbsp; //set pins to output because they are addressed in the main loop<br
/>&nbsp; pinMode(latchPin, OUTPUT);<br
/>&nbsp; pinMode(clockPin, OUTPUT);<br
/>&nbsp; pinMode(dataPin, OUTPUT);<br
/><br
/>}<br
/><br
/><br
/>void loop() {<br
/><br
/><br
/>&nbsp;&nbsp;&nbsp; lightPwm(100,<br
/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; random(GREYSCALES) / 10,<br
/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; random(GREYSCALES) / 10,<br
/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; random(GREYSCALES) / 10,<br
/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; random(GREYSCALES) / 10,<br
/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; random(GREYSCALES),<br
/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; random(GREYSCALES),<br
/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; random(GREYSCALES)<br
/>&nbsp;&nbsp;&nbsp;&nbsp; );<br
/><br
/><br
/>}<br
/><br
/><br
/>void lightPwm(long duration,&nbsp;<br
/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; int white,&nbsp;<br
/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; int r1, int g1, int b1,&nbsp;<br
/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; int r2, int g2, int b2) {<br
/>&nbsp;&nbsp;<br
/>&nbsp; byte data = 0;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br
/><br
/>&nbsp; // TODO: Gamma<br
/>&nbsp; int r1tar = r1;<br
/>&nbsp; int g1tar = g1;<br
/>&nbsp; int b1tar = b1;<br
/>&nbsp; int r2tar = r2;<br
/>&nbsp; int g2tar = g2;<br
/>&nbsp; int b2tar = b2;<br
/>&nbsp; int whtar = white;<br
/>&nbsp;&nbsp;<br
/>&nbsp; int r1inv = GREYSCALES - r1tar;<br
/>&nbsp; int g1inv = GREYSCALES - g1tar;<br
/>&nbsp; int b1inv = GREYSCALES - b1tar;<br
/>&nbsp; int r2inv = GREYSCALES - r2tar;<br
/>&nbsp; int g2inv = GREYSCALES - g2tar;<br
/>&nbsp; int b2inv = GREYSCALES - b2tar;<br
/>&nbsp; int whinv = GREYSCALES - whtar;<br
/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br
/><br
/>&nbsp; int r1err = 0;<br
/>&nbsp; int g1err = 0;<br
/>&nbsp; int b1err = 0;<br
/>&nbsp; int r2err = 0;<br
/>&nbsp; int g2err = 0;<br
/>&nbsp; int b2err = 0;<br
/>&nbsp; int wherr = 0;<br
/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br
/>&nbsp; for (int t=duration; t &gt;= 0; t--)&nbsp; {&nbsp;&nbsp;&nbsp;&nbsp;<br
/>&nbsp;&nbsp;&nbsp; data = 0;<br
/>&nbsp;&nbsp;&nbsp; for (int i=GREYSCALES-1; i &gt;= 0; i--)&nbsp; {<br
/><br
/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (r1err &gt; 0) {data |= B00000001; r1err -= r1inv;} else {data &amp;= ~B00000001; r1err += r1tar;}<br
/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (g1err &gt; 0) {data |= B00000010; g1err -= g1inv;} else {data &amp;= ~B00000010; g1err += g1tar;}<br
/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (b1err &gt; 0) {data |= B00000100; b1err -= b1inv;} else {data &amp;= ~B00000100; b1err += b1tar;}<br
/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (r2err &gt; 0) {data |= B00001000; r2err -= r2inv;} else {data &amp;= ~B00001000; r2err += r2tar;}<br
/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (g2err &gt; 0) {data |= B00010000; g2err -= g2inv;} else {data &amp;= ~B00010000; g2err += g2tar;}<br
/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (b2err &gt; 0) {data |= B00100000; b2err -= b2inv;} else {data &amp;= ~B00100000; b2err += b2tar;}<br
/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (wherr &gt; 0) {data |= B01000000; wherr -= whinv;} else {data &amp;= ~B01000000; wherr += whtar;}<br
/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br
/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br
/>/*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br
/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (r1 == i)&nbsp;&nbsp;&nbsp; data |= B00000001;<br
/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (g1 == i)&nbsp;&nbsp;&nbsp; data |= B00000010;<br
/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (b1 == i)&nbsp;&nbsp;&nbsp; data |= B00000100;<br
/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (r2 == i)&nbsp;&nbsp;&nbsp; data |= B00001000;<br
/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (g2 == i)&nbsp;&nbsp;&nbsp; data |= B00010000;<br
/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (b2 == i)&nbsp;&nbsp;&nbsp; data |= B00100000;<br
/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (white == i) data |= B01000000;<br
/>*/<br
/><br
/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; shiftOut(data);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br
/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; shiftOut(data);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br
/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; shiftOut(data);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br
/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; shiftOut(data);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br
/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; shiftOut(data);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br
/>&nbsp;&nbsp;&nbsp; }<br
/><br
/>&nbsp; }<br
/>}&nbsp;<br
/><br
/><br
/>inline void shiftOut(byte data) {<br
/><br
/>&nbsp; PORTB &amp;= ~LATCH_PORT; // Latch off<br
/><br
/>&nbsp; PORTB &amp;= ~CLOCK_PORT; // Clock off<br
/>&nbsp; if (data &amp; B00000001) PORTB |= DATA_PORT; else PORTB &amp;= ~DATA_PORT;<br
/>&nbsp; PORTB |=&nbsp; CLOCK_PORT; // Clock on<br
/><br
/>&nbsp; PORTB &amp;= ~CLOCK_PORT; // Clock off<br
/>&nbsp; if (data &amp; B00000010) PORTB |= DATA_PORT; else PORTB &amp;= ~DATA_PORT;<br
/>&nbsp; PORTB |=&nbsp; CLOCK_PORT; // Clock on<br
/>&nbsp;<br
/>&nbsp; PORTB &amp;= ~CLOCK_PORT; // Clock off<br
/>&nbsp; if (data &amp; B00000100) PORTB |= DATA_PORT; else PORTB &amp;= ~DATA_PORT;<br
/>&nbsp; PORTB |=&nbsp; CLOCK_PORT; // Clock on<br
/>&nbsp;<br
/>&nbsp; PORTB &amp;= ~CLOCK_PORT; // Clock off<br
/>&nbsp; if (data &amp; B00001000) PORTB |= DATA_PORT; else PORTB &amp;= ~DATA_PORT;<br
/>&nbsp; PORTB |=&nbsp; CLOCK_PORT; // Clock on<br
/>&nbsp;<br
/>&nbsp; PORTB &amp;= ~CLOCK_PORT; // Clock off<br
/>&nbsp; if (data &amp; B00010000) PORTB |= DATA_PORT; else PORTB &amp;= ~DATA_PORT;<br
/>&nbsp; PORTB |=&nbsp; CLOCK_PORT; // Clock on<br
/>&nbsp;<br
/>&nbsp; PORTB &amp;= ~CLOCK_PORT; // Clock off<br
/>&nbsp; if (data &amp; B00100000) PORTB |= DATA_PORT; else PORTB &amp;= ~DATA_PORT;<br
/>&nbsp; PORTB |=&nbsp; CLOCK_PORT; // Clock on<br
/>&nbsp;<br
/>&nbsp; PORTB &amp;= ~CLOCK_PORT; // Clock off<br
/>&nbsp; if (data &amp; B01000000) PORTB |= DATA_PORT; else PORTB &amp;= ~DATA_PORT;<br
/>&nbsp; PORTB |=&nbsp; CLOCK_PORT; // Clock on<br
/>&nbsp;<br
/>&nbsp; PORTB &amp;= ~CLOCK_PORT; // Clock off<br
/>&nbsp; if (data &amp; B10000000) PORTB |= DATA_PORT; else PORTB &amp;= ~DATA_PORT;<br
/>&nbsp; PORTB |=&nbsp; CLOCK_PORT; // Clock on<br
/><br
/>&nbsp; PORTB |=&nbsp; LATCH_PORT; // Latch on<br
/><br
/>}<br
/><br
/><br
/><br
/></body>
</html>
